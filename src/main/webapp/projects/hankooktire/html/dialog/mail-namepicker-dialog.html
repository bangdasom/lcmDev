<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>DWP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="../../assets/css/components-style.css"/>
    <link rel="stylesheet" href="../../assets/css/pages.css"/>
    <link rel="stylesheet" href="../../assets/css/pages-m.css"/>

    <script src="../../assets/lib/jquery/jquery-2.2.4.js"></script>
    <script src="../../assets/lib/jquery-ui/jquery-ui.min.js"></script>
    <script src="../../assets/lib/slick/slick.min.js"></script>
    <script src="../../assets/lib/bxSlider/jquery.bxslider.min.js"></script>
    <script src="../../assets/lib/mCustomScrollbar/jquery.mCustomScrollbar.concat.min.js"></script>
    <script src="../../assets/js/common-style.js"></script>
    <script src="../../assets/js/sub-layout.js"></script>
    <script src="../../assets/js/common-dialog.js"></script>
    <script src="../../assets/js/dynatree/jquery.dynatree.js"></script>
    <script>
        $(function() {
            var treeData ={
                receive: [],
                refer:[],
                blind:[]
            };

            var dropOts = {
                hoverClass: "drophover",
                addClasses: true,
                over: function(event, ui) {
                    logMsg("droppable.over, %o, %o", event, ui);
                },
                drop: function(event, ui) {
                    var list = [];
                    if(ui.draggable[0].id != 'tree'){
                        addMember($(event.target),treeData,$(ui.draggable[0]).parent().children());
                    }else{
                        addMember($(event.target),treeData);
                    }
                    $(".dwp-item").draggable({
                        cursor:"move",
                        helper: dragIcon,
                        containment:".dwp-form-scroll",
                        start: function (e, ui) {
                            ui.helper.animate({
                                width: 80,
                                height: 50
                            });
                        },
                        cursorAt: {left:10, top:10}
                    });
                }
            };

            $("#dialog").dialog({
                title: "수신",
                width: 736,
                height: 600,
                /* 기본옵션 */
                modal: true,
                draggable: false,
                hide: { effect: "fade", duration: 300 },
                show: { effect: "fade", duration: 300 },
                resizable: true,
                open: function() {
                    /* 검은막 클릭시 dialog 닫힘 */
                    $('.ui-widget-overlay').on('click', function() {
                        $('#dialog').dialog('close');
                    });

                    /* 왼쪽 트리 */
                    if($("#tree .dynatree-container").length < 1) {
                        $("#tree").dynatree({
                            checkbox:true,
                            children: [
                                {"title": "1Depth Group", "isFolder": true, "key": "folder1",
                                    "children":[
                                        {"title": "크라운", "key": "emp6"},
                                        {"title": "땅콩", "key": "emp7"},
                                        {"title": "카라멜", "key": "emp8"}
                                    ]},
                                {"title": "1Depth Group", "isFolder": true, "key": "folder2",
                                    "children": [
                                        {"title": "2Depth Group", "isFolder": true, "key": "folder2-1"},
                                        {"title": "2Depth Group", "isFolder": true, "key": "folder2-2",
                                            "children": [
                                                {"title": "3Depth Group", "isFolder": true, "key": "folder2-2-1"},
                                                {"title": "3Depth Group", "isFolder": true, "key": "folder2-2-2",
                                                    "children": [
                                                        {"title": "4Depth Group", "isFolder": true, "key": "folder2-2-2-1",
                                                            "children" : [
                                                                {"title": "비주얼커뮤니케이션1", "key": "emp1"},
                                                                {"title": "장그래", "key": "emp2"},
                                                                {"title": "안그래", "key": "emp3"},
                                                                {"title": "현빈", "key": "emp4"},
                                                                {"title": "사람", "key": "emp5"}
                                                            ]
                                                        },
                                                        {"title": "4Depth Group", "isFolder": true, "key": "folder2-2-2-2"}
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ],

                            helper: "clone",
                            dnd: {
                                /* 폴더는 드래그 안되게 */
                                onDragStart: function(node) {
                                    if(node.data.isFolder){
                                        return false;
                                    }
                                    return true;
                                }
                            }
                        });

                        /* 드래그 앤 드랍 */
                        if(!$(".dwp-list-body").hasClass(".ui-droppable")) {

                            $(".dwp-item").draggable({
                                cursor:"move",
                                helper: dragIcon,
                                containment:".dwp-form-scroll",
                                start: function (e, ui) {
                                    ui.helper.animate({
                                        width: 80,
                                        height: 50
                                    });
                                },
                                cursorAt: {left:10, top:10}
                            });

                            $(".dwp-list-body").droppable(dropOts);
                        }
                    }
                }
            });



            /* 수신 버튼 클릭시 */
            $(document).on("click", ".btn-add.receive", function() {
                addMember($(".form-receive .dwp-list-body"),treeData);
                if(!$(".dwp-list-body").hasClass(".ui-droppable")) {

                    $(".dwp-item").draggable({
                        cursor:"move",
                        helper: dragIcon,
                        containment:".dwp-form-scroll",
                        start: function (e, ui) {
                            ui.helper.animate({
                                width: 80,
                                height: 50
                            });
                        },
                        cursorAt: {left:10, top:10}
                    });

                    $(".dwp-list-body").droppable(dropOts);
                }
            });

            /* 참조 버튼 클릭시 */
            $(document).on("click", ".btn-add.refer", function() {
                addMember($(".form-refer .dwp-list-body"),treeData);
                if(!$(".dwp-list-body").hasClass(".ui-droppable")) {

                    $(".dwp-item").draggable({
                        cursor:"move",
                        helper: dragIcon,
                        containment:".dwp-form-scroll",
                        start: function (e, ui) {
                            ui.helper.animate({
                                width: 80,
                                height: 50
                            });
                        },
                        cursorAt: {left:10, top:10}
                    });

                    $(".dwp-list-body").droppable(dropOts);
                }
            });

            /* 비밀참조 버튼 클릭시 */
            $(document).on("click", ".btn-add.blind", function() {
                addMember($(".form-blind-refer .dwp-list-body"),treeData);
                if(!$(".dwp-list-body").hasClass(".ui-droppable")) {

                    $(".dwp-item").draggable({
                        cursor:"move",
                        helper: dragIcon,
                        containment:".dwp-form-scroll",
                        start: function (e, ui) {
                            ui.helper.animate({
                                width: 80,
                                height: 50
                            });
                        },
                        cursorAt: {left:10, top:10}
                    });

                    $(".dwp-list-body").droppable(dropOts);
                }
            });

            /* 삭제 버튼 클릭시 */
            $(document).on("click", ".btn-del", function() {
                $(".dwp-list-body .dwp-item.active").remove();
            });

            /* X 버튼 클릭시 */
            $(document).on("click", ".dwp-list-body .dwp-item .btn-cancel", function() {
                $(this).closest(".dwp-item").remove();
            });

            $(document).on("click",".dwp-btn.confirm",function(){
               console.log(treeData);
            });

            /* 전체삭제 버튼 클릭시 */
            $(document).on("click", ".btn-all-del", function() {
                $(".dwp-list-body .dwp-item").remove();
            });

            /* 오른쪽 영역의 아이템 클릭시 표시 */
            $(document).on("click", ".dwp-list-body .dwp-item", function() {
                $(this).toggleClass("active");
            });

            function dragIcon( event ) {
                return '<span id="dragIcon"></span>';
            }

            /* 오른쪽 영역으로 멤버 추가 함수 */
            function addMember(element,treeData,sideItem) {
                var target = element;/*$(".dwp-list-body");*/
                var selected = [];
                if(typeof sideItem == 'undefined'){
                    selected = $("#tree").dynatree("getSelectedNodes");

                    for(var i = 0; i < selected.length; i++) {
                        var key = selected[i].data.key;
                        var title = selected[i].data.title;

                        var item = "<div class='dwp-item' data-key='" + key + "'>";
                        item += "<span>"+title+"</span>";
                        item += "<button type='button' class='btn-cancel'>삭제</button>";
                        item += "</div>";

                        if (!selected[i].data.isFolder) {
                            var flag = false;

                            /* 중복검사 */
                            $(".dwp-list-body .dwp-item").each(function () {
                                var selKey = $(this).attr("data-key");
                                if (selKey == key) {
                                    flag = true;
                                }
                            });
                            if (!flag) {
                                target.append(item);
                                if (target.parent().hasClass("form-receive")) {
                                    treeData.receive.push({"title": title, "key": key});
                                } else if (target.parent().hasClass("form-refer")) {
                                    treeData.refer.push({"title": title, "key": key});
                                } else {
                                    treeData.blind.push({"title": title, "key": key});
                                }
                            }
                        }
                    }
                }else{

                    var selected = [];

                    for(i=0;i<sideItem.length;i++){
                        if($(sideItem[i]).hasClass("active")){
                            selected.push({"data":{
                                "title":$(sideItem[i]).children("span").text(),
                                "key":$(sideItem[i]).attr("data-key"),
                                "isFolder":false
                            }});
                        };
                    }

                    for(var i = 0; i < selected.length; i++) {
                        var key = selected[i].data.key;
                        var title = selected[i].data.title;

                        var item = "<div class='dwp-item' data-key='" + key + "'>";
                        item += "<span>"+title+"</span>";
                        item += "<button type='button' class='btn-cancel'>삭제</button>";
                        item += "</div>";

                        if (!selected[i].data.isFolder) {
                            var flag = false;

                            /* 중복검사 */
                            $(".dwp-list-body .dwp-item").each(function () {
                                var selKey = $(this).attr("data-key");
                                if (selKey == key) {
                                    $(this).remove();
                                }
                            });
                            target.append(item);
                            $(".dwp-list-body .dwp-item").droppable(dropOts);
                            if (target.parent().hasClass("form-receive")) {
                                treeData.receive.push({"title": title, "key": key});
                            } else if (target.parent().hasClass("form-refer")) {
                                treeData.refer.push({"title": title, "key": key});
                            } else {
                                treeData.refer.push({"title": title, "key": key});
                            }
                        }
                    }
                }
                return treeData;
            }
        });
    </script>

</head>
<body>
    <div id="dialog" title="Basic dialog">
        <div class="dwp-mail-namepicker-dialog dwp-namepicker">
            <div class="dwp-tabs">
                <ul class="dwp-tabs-header">
                    <li><a href="#dwp-tabs-content">조직도</a></li>
                    <li><a href="#dwp-tabs-content">주소록</a></li>
                </ul>
                <div class="dwp-tabs-content" id="dwp-tabs-content">
                    <div class="dwp-namepicker-inner">
                        <!-- 왼쪽 트리 -->
                        <div class="dwp-tree-area">

                            <div class="dwp-search-area">
                                <div class="dwp-search-bar">
                                    <input type="text">
                                    <div class="dwp-btn icon"><button type="button"><img src="../../assets/images/common/icon-search.svg" alt=""></button></div>
                                </div>
                                <div class="dwp-btn icon">
                                    <button type="button"><img src="../../assets/images/common/icon-refresh.svg" alt=""></button>
                                </div>
                            </div>

                            <div class="dwp-tree org-type">
                                <div id="tree"></div>
                            </div>
                        </div>

                        <!-- 버튼 영역 -->
                        <div class="dwp-btn-area">
                            <div class="dwp-btn btn-add receive"><button type="button">수신</button></div>
                            <div class="dwp-btn btn-add refer"><button type="button">참조</button></div>
                            <div class="dwp-btn btn-add blind"><button type="button">비밀참조</button></div>
                            <div class="dwp-btn btn-all-del"><button type="button">모두삭제</button></div>
                        </div>

                        <!-- 오른쪽 영역 -->
                        <div class="dwp-form-area">
                            <div class="aligner" data-bottom="xs">
                                <div class="right">
                                    <div class="dwp-btn"><button type="button">수신처 저장</button></div>
                                    <div class="dwp-btn"><button type="button">수신처 불러오기</button></div>
                                </div>
                            </div>

                            <div class="dwp-form-scroll">
                                <div class="form-receive">
                                    <div class="dwp-list-head">수신</div>
                                    <div class="dwp-list-body">
                                        <div class="dwp-item">
                                            Default<button type="button" class="btn-cancel">삭제</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-refer">
                                    <div class="dwp-list-head">참조</div>
                                    <div class="dwp-list-body">
                                        <div class="dwp-item">
                                            Default<button type="button" class="btn-cancel">삭제</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-blind-refer">
                                    <div class="dwp-list-head">비밀참조</div>
                                    <div class="dwp-list-body">
                                        <div class="dwp-item">
                                            Default<button type="button" class="btn-cancel">삭제</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="aligner" data-top="md" data-type="table">
            <div class="center">
                <div class="dwp-grouping">
                    <div class="dwp-btn confirm"><button type="button">확인</button></div>
                    <div class="dwp-btn cancel"><button type="button">취소</button></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
