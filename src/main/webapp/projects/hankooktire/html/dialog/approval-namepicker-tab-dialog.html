<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>DWP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="../../assets/css/components-style.css"/>
    <link rel="stylesheet" href="../../assets/css/pages.css"/>
    <link rel="stylesheet" href="../../assets/css/pages-m.css"/>

    <script src="../../assets/lib/jquery/jquery-2.2.4.js"></script>
    <script src="../../assets/lib/jquery-ui/jquery-ui.min.js"></script>
    <script src="../../assets/lib/slick/slick.min.js"></script>
    <script src="../../assets/lib/bxSlider/jquery.bxslider.min.js"></script>
    <script src="../../assets/lib/mCustomScrollbar/jquery.mCustomScrollbar.concat.min.js"></script>
    <script src="../../assets/js/common-style.js"></script>
    <script src="../../assets/js/sub-layout.js"></script>
    <script src="../../assets/js/common-dialog.js"></script>
    <script src="../../assets/js/dynatree/jquery.dynatree.js"></script>
    <script>
        $(function() {
            var approval_consent_list = [
                        {"title":"크라운"
                            ,"key":"emp6"
                            ,"isFolder":false
                            ,"division":"ap"
                            ,"children":[
                        ]}
                    ];

            $("#dialog").dialog({
                title: "결재선",
                width: 928,
                /* 기본옵션 */
                modal: true,
                draggable: false,
                hide: { effect: "fade", duration: 300 },
                show: { effect: "fade", duration: 300 },
                resizable: false,
                open: function() {
                    var current = this;

                    addMember();
                    /* 검은막 클릭시 dialog 닫힘 */
                    $('.ui-widget-overlay').on('click', function() {
                        $('#dialog').dialog('close');
                    });

                    /* 왼쪽 트리 */
                    if($("#tree .dynatree-container").length < 1) {
                        $("#tree").dynatree({
                            checkbox:true,
                            /*initAjax: {
                                url: "../../assets/js/dynatree/sampjson2.json"
                            },*/
                            children:[
                                {"title": "1Depth Group", "isFolder": true, "key": "folder1", expand: true,
                                    "children":[
                                        {"title": "크라운", "key": "emp6"},
                                        {"title": "땅콩", "key": "emp7"},
                                        {"title": "카라멜", "key": "emp8"}
                                    ]},
                                {"title": "1Depth Group", "isFolder": true, "key": "folder2",
                                    "children": [
                                        {"title": "2Depth Group", "isFolder": true, "key": "folder2-1"},
                                        {"title": "2Depth Group", "isFolder": true, "key": "folder2-2",
                                            "children": [
                                                {"title": "3Depth Group", "isFolder": true, "key": "folder2-2-1"},
                                                {"title": "3Depth Group", "isFolder": true, "key": "folder2-2-2",
                                                    "children": [
                                                        {"title": "4Depth Group", "isFolder": true, "key": "folder2-2-2-1",
                                                            "children" : [
                                                                {"title": "비주얼커뮤니케이션1", "key": "emp1"},
                                                                {"title": "장그래", "key": "emp2"},
                                                                {"title": "안그래", "key": "emp3"},
                                                                {"title": "현빈", "key": "emp4"},
                                                                {"title": "사람", "key": "emp5"}
                                                            ]
                                                        },
                                                        {"title": "4Depth Group", "isFolder": true, "key": "folder2-2-2-2"}
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ],
                            helper: "clone",
                            dnd: {
                                /* 폴더는 드래그 안되게 */
                                onDragStart: function(node) {
                                    if(node.data.isFolder){
                                        return false;
                                    }
                                    return true;
                                }
                            }
                        });

                        /* 드래그 앤 드랍 */
                        if(!$(".dwp-list-body").hasClass(".ui-droppable")) {

                            $(".approval-body").droppable({
                                hoverClass: "drophover",
                                addClasses: true,
                                drop: function(event, ui) {
                                    makeTree($(this));
                                    addMember($(this));
                                    deselect();
                                }
                            });
                        }
                    }
                }
            });

            /* 결재 추가 버튼 클릭시 */
            $(document).on("click", ".btn-add.approval", function() {
                makeTree($(".approval-body"));
                addMember();
            });

            /* 합의 추가 버튼 클릭시 */
            $(document).on("click", ".btn-add.consent", function() {
                var data_key="";
                if($(".approval-body .dwp-item.active").length!=0){
                    data_key = $(".approval-body .dwp-item.active").attr("data-key");
                }else{
                    return;
                }
                var index = $(".approval-body .dwp-item.active").children("span").text() -1;
                var selected = $("#tree").dynatree("getSelectedNodes");
                for(var i =0; i<selected.length;i++){
                    if(index != -1){
                        if(index ==0){
                            return;
                        }
                        if(!overlapCheck(selected[i])) {
                            var approval_consent = {};
                            approval_consent.title = selected[i].data.title;
                            approval_consent.key = selected[i].data.key;
                            approval_consent.isFolder = false;
                            approval_consent.division = "ag";
                            approval_consent.approval = approval_consent_list[index].key;
                            approval_consent_list[index].children.push(approval_consent);
                        }
                    }/*else{
                        if(!overlapCheck(selected[i])){
                            var approval_consent = {};
                            approval_consent.title = selected[i].data.title;
                            approval_consent.key = selected[i].data.key;
                            approval_consent.isFolder = false;
                            approval_consent_list[0].children.push(approval_consent);
                        }
                    }*/
                }

                addMember($(".approval-body"),data_key);
            });

            /*올리기 버튼 누를시*/
            $(document).on("click", ".dwp-btn.icon.up-style", function() {
                var $this = $(".dwp-form-area .dwp-item.active");
                var data_key = $this.attr("data-key");

                if($this.length==0){
                    return;
                }

                if($this.parent().parent().hasClass("approval-body")){
                    var parent = $this.children("span").text() -1;
                    if(parent!=0 && parent!=1){
                        var clone = $.extend(true,{}, approval_consent_list);
                        approval_consent_list.splice(parent,1);
                        approval_consent_list.splice(parent-1,0,clone[parent]);
                    }
                    addMember("approval-body",data_key);
                }else{
                    var parent = $this.parent().attr("data-parent");
                    var child = $this.children("button").attr("data-child");
                    if(parent!=0 && parent !=1){
                        var clone = $.extend(true,{}, approval_consent_list);
                        approval_consent_list[parent].children.splice(child,1);
                        clone[parent].children[child].approval = approval_consent_list[parent-1].key;
                        approval_consent_list[parent-1].children.push(clone[parent].children[child]);
                    }
                    addMember("approval-body",data_key);
                }
            });

            /*내리기 버튼 누를시*/
            $(document).on("click", ".dwp-btn.icon.down-style", function() {
                var $this = $(".dwp-form-area .dwp-item.active");
                var data_key = $this.attr("data-key");

                if($this.length==0){
                    return;
                }

                if($this.parent().parent().hasClass("approval-body")){
                    var parent = Number($this.children("span").text()) -1;
                    if((approval_consent_list.length-1) != parent && parent !=0){
                        var clone = $.extend(true,{}, approval_consent_list);
                        approval_consent_list.splice(parent,1);
                        approval_consent_list.splice(parent+1,0,clone[parent]);
                    }
                    addMember("approval-body",data_key);
                }else{
                    var parent = Number($this.parent().attr("data-parent"));
                    var child = Number($this.children("button").attr("data-child"));
                    if((approval_consent_list.length-1) != parent && parent !=0){
                        var clone = $.extend(true,{}, approval_consent_list);
                        approval_consent_list[parent].children.splice(child,1);
                        clone[parent].children[child].approval = approval_consent_list[parent+1].key;
                        approval_consent_list[parent+1].children.push(clone[parent].children[child]);
                    }
                    addMember("approval-body",data_key);
                }
            });

            /* X 버튼 클릭시 */
            $(document).on("click", ".dwp-list-body .approval-body .dwp-item .btn-cancel", function() {
                var index = ($(this).prev("span").text()-1);
                if(index == 0){
                    return ;
                }
                approval_consent_list.splice(index , 1);
                addMember($(".approval-body"));
            });

            $(document).on("click", ".dwp-list-body .consent-body .dwp-item .btn-cancel", function() {
                var parent = $(this).parent().parent().attr("data-parent");
                var child = $(this).attr("data-child");
                console.log(parent);

                approval_consent_list[parent].children.splice(child,1);
                addMember();
            });

            /* 전체삭제 버튼 클릭시 */
            $(document).on("click", ".btn-all-del", function() {
                var clone = $.extend(true,{},approval_consent_list);
                approval_consent_list = [];
                approval_consent_list.push(clone[0]);
                addMember($(".approval-body"));
            });

            /* 확인 버튼 클릭시 */
            $(document).on("click", ".dwp-btn.confirm", function() {
                var data = [];
                data.push(approval_consent_list[0]);
                for(var i=1; i<approval_consent_list.length;i++){
                    if(approval_consent_list[i].children.length!=0){
                        for(var j=0; j<approval_consent_list[i].children.length;j++){
                            data.push(approval_consent_list[i].children[j]);
                        }
                        data.push(approval_consent_list[i]);
                    }
                }
                console.log(data);
            });

            /* 오른쪽 영역의 아이템 클릭시 표시 */
            $(document).on("click", ".dwp-list-body .dwp-item", function() {
                $(this).toggleClass("active");
                $(".dwp-form-area .dwp-item").not($(this)).removeClass("active");
            });

            function overlapCheck(selectedItem){
                if(!selectedItem.data.isFolder) {
                    var flag = false;
                    var key = selectedItem.data.key;
                    $(".dwp-list-body .dwp-item").each(function() {
                        var selKey = $(this).attr("data-key");
                        if(selKey == key) {
                            flag = true;
                        }
                    });
                    return flag;
                }else{
                    return true;
                }
            }

            function deselect(){
                $("#tree").dynatree("getRoot").visit(function(dtnode){
                    dtnode.select(false);
                });
                return false;
            }

            function makeTree(element){
                var target = element;/*$(".dwp-list-body")*/
                var selected = $("#tree").dynatree("getSelectedNodes");
                for(var i = 0; i < selected.length; i++) {
                    if(!selected[i].data.isFolder) {
                        var flag = false;
                        var key = selected[i].data.key;
                        /* 중복검사 */
                        $(".dwp-list-body .dwp-item").each(function() {
                            var selKey = $(this).attr("data-key");
                            if(selKey == key) {
                                flag = true;
                            }
                        });
                        if(!flag) {
                            var approval_consent = {};
                            if(target.hasClass("approval-body")){
                                approval_consent.title = selected[i].data.title;
                                approval_consent.key = selected[i].data.key;
                                approval_consent.isFolder = false;
                                approval_consent.division = "ap";
                                approval_consent.children = [];
                                approval_consent_list.push(approval_consent);
                            }else if(target.parent().hasClass("consent-body")){
                                approval_consent.title = selected[i].data.title;
                                approval_consent.key = selected[i].data.key;
                                approval_consent.isFolder = false;
                                approval_consent.division = "ag";
                                approval_consent.approval = approval_consent_list[target.attr("data-parent")].key;
                                if(typeof approval_consent_list[target.attr("data-parent")].children=='undefined'){
                                    approval_consent_list[target.attr("data-parent")].children = [];
                                }
                                approval_consent_list[target.attr("data-parent")].children.push(approval_consent);
                            }
                        }
                    }
                }
            }

            /* 오른쪽 영역으로 멤버 추가 함수 */
            function addMember(element,data_key) {
                var target = element;

                $(".item-wrap").each(function(){
                   $(this).remove();
                });

                for(var i = 0; i < approval_consent_list.length; i++) {
                    var key = approval_consent_list[i].key;
                    var title = approval_consent_list[i].title;
                    var children = approval_consent_list[i].children;


                    var approvalItem =  "<div class='item-wrap'>";
                    approvalItem += "<div class='dwp-item' data-key='"+key+"'>";
                    approvalItem += '<span class="num">'+(i+1)+'</span>';
                    approvalItem += title;
                    approvalItem += "<button type='button' class='btn-cancel'>삭제</button>";
                    approvalItem += "</div>";
                    if(typeof approval_consent_list[i].children != 'undefined' && approval_consent_list[i].children.length!=0){
                        for(var j=1;j<children.length;j++){
                            approvalItem += "<div class='empty-item no-border'></div>"
                        }
                    }
                    approvalItem += "</div>";
                    $(".approval-body").append(approvalItem);

                    var consentItem = "<div class='item-wrap' data-parent='"+i+"'>";
                    if(typeof approval_consent_list[i].children != 'undefined' && approval_consent_list[i].children.length!=0){
                        for(var j=0;j<children.length;j++){
                            consentItem += "<div class='dwp-item' data-key='"+children[j].key+"'>";
                            consentItem += children[j].title;
                            consentItem += "<button type='button' data-child='"+j+"' class='btn-cancel'>삭제</button>";
                            consentItem += "</div>";
                        }
                    }else{
                        consentItem +="<div class='empty-item'></div>";
                    }
                    consentItem += "</div>";
                    $(".consent-body").append(consentItem);

                    $(".consent-body .item-wrap").droppable({
                        hoverClass: "drophover",
                        addClasses: true,
                        drop: function(event, ui) {

                            var dropParent = Number($(this).attr("data-parent"));
                            if(dropParent == 0) {
                                return;
                            }
                            makeTree($(this));
                            addMember($(this));
                        }
                    });
                }

                if(typeof data_key !='undefined'){
                    $(".dwp-item").each(function(){
                        if($(this).attr("data-key")==data_key){
                            $(this).addClass("active");
                        }
                    })
                }


                $(".approval-body .dwp-item").draggable({
                    cursor:"move",
                    helper: 'clone',
                    containment:".approval-body",
                    start:function(){
                        if(!$(this).hasClass("active")){
                            return false;
                        }
                    }
                });

                $(".consent-body .dwp-item").draggable({
                    cursor:"move",
                    helper: 'clone',
                    containment:".consent-body",
                    start:function(){
                        if(!$(this).hasClass("active")){
                            return false;
                        }
                    }
                });

                $(".approval-body .dwp-item").droppable({
                    hoverClass: "dwp-item-drophover",
                    addClasses: true,
                    drop: function(event, ui) {

                        if(!$(ui.draggable).hasClass("active")){
                            return;
                        }

                        var dropIndex = Number($(this).children("span").text())-1;
                        var dragIndex = Number($(ui.draggable).children("span").text())-1;
                        var clone = $.extend(true,{}, approval_consent_list);

                        if(dropIndex  == 0) {
                            return;
                        }
                        approval_consent_list.splice(dragIndex,1);
                        approval_consent_list.splice(dropIndex,0,clone[dragIndex]);
                        addMember("approval-body",$(ui.draggable).attr("data-key"));
                    }
                });
                $(".consent-body .dwp-item").droppable({
                    hoverClass: "dwp-item-drophover",
                    addClasses: true,
                    drop: function(event, ui) {
                        if($(ui.draggable).closest("#tree").length==1) {
                            makeTree($(this));
                            addMember($(this));
                        }else{
                            var dragParent = Number($(ui.draggable).parent().attr("data-parent"));
                            var dragChild = Number($(ui.draggable).children("button").attr("data-child"));

                            var dropParent = Number($(this).parent().attr("data-parent"));

                            if(dragParent == dropParent){
                                return;
                            }

                            var clone = $.extend(true,{}, approval_consent_list);

                            approval_consent_list[dragParent].children.splice(dragChild,1);
                            clone[dragParent].children[dragChild].approval = approval_consent_list[dropParent].key;
                            approval_consent_list[dropParent].children.push(clone[dragParent].children[dragChild]);
                            addMember("approval-body",$(ui.draggable).attr("data-key"));
                        }
                    }
                });

                $(".consent-body .empty-item").droppable({
                    hoverClass: "dwp-item-drophover",
                    addClasses: true,
                    drop: function(event, ui) {
                        var dropParent = Number($(this).parent().attr("data-parent"));

                        if(dropParent == 0) {
                            return;
                        }

                        if($(ui.draggable).closest("#tree").length==1){
                            makeTree($(this));
                            addMember($(this));
                            deselect();
                        }else{
                            var dragParent = Number($(ui.draggable).parent().attr("data-parent"));
                            var dragChild = Number($(ui.draggable).children("button").attr("data-child"));

                            if(dragParent == dropParent){
                                return;
                            }

                            var clone = $.extend(true,{}, approval_consent_list);

                            approval_consent_list[dragParent].children.splice(dragChild,1);
                            clone[dragParent].children[dragChild].approval = approval_consent_list[dropParent].key;
                            approval_consent_list[dropParent].children.push(clone[dragParent].children[dragChild]);
                            addMember("approval-body",$(ui.draggable).attr("data-key"));
                        }

                    }
                });

            }
        });
    </script>

    <script>


    </script>

</head>
<body>
    <div id="dialog" title="Basic dialog">
        <div class="dwp-approval-namepicker-dialog dwp-namepicker">

            <div class="dwp-tabs-content" id="dwp-tabs-content">

                <div class="dwp-namepicker-inner">
                    <!-- 왼쪽 트리 -->
                    <div class="dwp-tree-area">

                        <div class="dwp-search-area">
                            <div class="dwp-search-bar">
                                <input type="text">
                                <div class="dwp-btn icon"><button type="button"><img src="../../assets/images/common/icon-search.svg" alt=""></button></div>
                            </div>
                            <div class="dwp-btn icon">
                                <button type="button"><img src="../../assets/images/common/icon-refresh.svg" alt=""></button>
                            </div>
                        </div>

                        <div class="dwp-tree">
                            <div id="tree"></div>
                        </div>
                    </div>

                    <!-- 버튼 영역 -->
                    <div class="dwp-btn-area">
                        <div class="dwp-btn btn-add approval"><button type="button">결재추가</button></div>
                        <div class="dwp-btn btn-add consent" ><button type="button">합의추가</button></div>
                        <div class="dwp-btn btn-all-del"><button type="button">모두삭제</button></div>
                        <div class="btn-group">
                            <div class="dwp-btn icon up-style"><button type="button"><img src="../../assets/images/common/up-arrow.svg" alt=""></button></div>
                            <div class="dwp-btn icon down-style"><button type="button"><img src="../../assets/images/common/down-arrow.svg" alt=""></button></div>
                        </div>
                    </div>

                    <!-- 오른쪽 영역 -->
                    <div class="dwp-form-area">

                        <div class="aligner" data-bottom="xs">
                            <div class="left">
                            </div>
                            <div class="right">
                                <div class="dwp-btn"><button type="button">결재선 저장</button></div>
                                <div class="dwp-btn"><button type="button">결재선 불러오기</button></div>
                            </div>
                        </div>

                        <div class="dwp-list-head">
                            <div class="approval-area">
                                <div class="aligner" data-type="table">
                                    <div class="left">결재</div>
                                    <div class="right">
                                        <div class="dwp-input expended">
                                            <input type="text" placeholder="결재자를 입력하세요.">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="consent-area">
                                <div class="aligner" data-type="table">
                                    <div class="left">합의</div>
                                    <div class="right">
                                        <div class="dwp-input expended">
                                            <input type="text" placeholder="합의자를 입력하세요.">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="dwp-list-body">
                            <div class="inner">
                                <div class="approval-body">

                                </div>
                                <div class="consent-body">

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="aligner" data-top="md" data-type="table">
                <div class="center">
                    <div class="dwp-grouping">
                        <div class="dwp-btn confirm"><button type="button">확인</button></div>
                        <div class="dwp-btn cancel"><button type="button">취소</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
